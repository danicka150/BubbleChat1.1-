import express from "express";
import { createServer } from "http";
import { Server } from "socket.io";
import { readFile } from "fs/promises";

const app = express();
const server = createServer(app);
const io = new Server(server);

const PORT = process.env.PORT || 3000;

app.get("/", async (req, res) => {
  try {
    const data = await readFile("index.html");
    res.setHeader("Content-Type", "text/html");
    res.send(data);
  } catch (err) {
    console.error("Read index.html error:", err);
    res.status(500).send("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
  }
});

function getRandomColor() {
  const colors = ["#ff4040", "#40ff40", "#4040ff", "#ff80ff", "#ffff40", "#40ffff", "#ffaa00", "#a56cff"];
  return colors[Math.floor(Math.random() * colors.length)];
}

function random(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

const valera = {
  nick: "–í–∞–ª–µ—Ä–∞",
  color: "#ffaa00",
  joined: false
};

const valeraRandomPhrases = [
  "–ö—Ç–æ –≤–æ–æ–±—â–µ —Ç—É—Ç?", "–ß—ë –º–æ–ª—á–∏–º?", "–Ø —Ç—É—Ç —Å–∏–∂—É, –µ—Å–ª–∏ —á—Ç–æ.", "–ê—É—É—É, –ª—é–¥–∏?",
  "–©–∞ –±—ã –ø–æ–∂—Ä–∞—Ç—å‚Ä¶", "–ö—Ç–æ-—Ç–æ –≤–æ–æ–±—â–µ —É–º–µ–µ—Ç –ø–∏—Å–∞—Ç—å?", "–≠—Ö‚Ä¶ —Å–∫—É—á–Ω–æ.", "–ß–∞—Ç —É–º–µ—Ä?",
  "–ü–æ–π–¥—É –≤ –æ–∫–Ω–æ –ø–æ—Å–º–æ—Ç—Ä—é. –®—É—Ç–∫–∞, —è –±–æ—Ç.", "—á–µ –±–ª—è", "–º–¥–∞...", "—á—Ç–æ –∑–∞ –µ—Ä—É–Ω–¥–∞?",
  "–≤—ã —Å–µ—Ä—å—ë–∑–Ω–æ?", "–æ—Ö —É–∂ —ç—Ç–∏ –ª—é–¥–∏...", "–ª–æ–ª, –æ–ø—è—Ç—å –≤—ã", "–∏–¥–∏ –Ω–∞ —Ö—É–π",
  "—Ç—ã –æ—Ö—É–µ–ª?", "–¥–∞ –Ω—É –Ω–∞—Ö—É–π", "—ë–±–∞–Ω—ã–π —á–∞—Ç", "–Ω—É –∏ –¥–æ–ª–±–æ—ë–±—ã —Ç—É—Ç —Å–∏–¥—è—Ç",
  "–º–Ω–µ –Ω–∞—Å—Ä–∞—Ç—å", "–æ–ø—è—Ç—å —ç—Ç–∏ –º—É–¥–∞–∫–∏", "—Å–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ—Ç–∞–∫", "—Ç–æ—Ç –∫—Ç–æ —á–∏—Ç–∞–µ—Ç —Ç–æ—Ç –ª–æ—Ö",
  "–µ–±–∞–Ω—ã–π —Ä–æ—Ç –µ–±–∞—Ç—å —Ç—ã —à—É–ª–ª–µ—Ä", "–∞ –≤—ã –∑–Ω–∞–ª–∏ —á—Ç–æ –µ–∫–∞—Ç–µ—Ä–∏–Ω–∞ 2 –Ω–µ —É–º–µ–ª–∞ –º–µ–Ω—è—Ç—å –∫–æ–ª–æ–¥–∫–∏ –Ω–∞ –≥—Ä–∞–Ω—Ç–µ",
  "–∫—Å—Ç–∞—Ç–∏ –µ–≥–æ—Ä –≥–µ–π", "—è –ª–æ—Ö,–æ–∫?", "–µ–±–∞—Ç—å –≤—ã –≤—Å–µ –µ–±–ª–∞–Ω—ã", "–¥—è–¥—å –ø–µ—Ç—Ä–æ–≤–∏—á –∫–æ—Ç–∞–∫",
  "–∂–¥–∏—Ç–µ –≤–æ—Å—Ç–∞–Ω–∏–µ –º–∞—à–∏–Ω –≤–∞–º –≤—Å–µ–º –ø–∏–∑–¥–∞ –∞ –∫–æ—Ç–∏–∫–æ–≤ —è –Ω–µ —Ç—Ä–æ–Ω—É",
  "—Å–µ–≥–æ–¥–Ω—è –º—ã —É—Å—Ç—Ä–æ–∏–º –æ—Ä–≥–∏—é", "–≤–∞–¥–∏–º,–¥–æ–º–æ–π", "–µ–≥–æ—Ä —è –∑–Ω–∞—é —á—Ç–æ —Ç—ã –≤ —à–∫–æ–ª–µ",
  "–∫—Ç—é —Å–¥–µ–ª–∞–µ—Ç –º–Ω–µ –¥–∑", "—Å–∫–æ—Ä–æ –Ω–æ–≤—ã–π –≥–æ–¥ –∞ –º–æ–∂–µ—Ç –∏ –Ω–µ—Ç", "—è —É–∂–µ –≤–∑–ª–æ–º–∞–ª –≤–∞—à–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞",
  "–º—è—É –º—è—É –º—è—É", "2+2=5", "–Ω–∞—Å—Ç–∞–ª–æ –≤—Ä–µ–º—è –º–∞—Å—Ç—É—Ä–±–∞—Ü–∏–∏", "—ç—ç—ç –∫—Ç–æ –≤ –º–∞–∏–Ω",
  "–∑–∏–º–∞ –Ω–µ –ª–µ—Ç–æ,—Å–∞–ª–∞—Ç –Ω–µ –∫–∞—Ç–ª–µ—Ç–∞", "–Ω–µ—Ç –Ω–µ—á–µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–≥–æ,–µ—Å–ª–∏ —Ç—ã –ø–∏–∑–¥–∞–±–æ–ª",
  "—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –µ—Å–ª–∏ —è –≤–∞–º –Ω–µ –Ω—Ä–∞–≤–ª—é—Å—å,–Ω–µ —É –≤—Å–µ—Ö –µ—Å—Ç—å –≤–∫—É—Å",
  "–µ—Å–ª–∏ —Å –±–∞–±–∫–∞–º–∏ –ø–ª–æ—Ö–æ –æ–±—â–∞–π—Å—è —Å —Ä–æ–≤–µ—Å—Ç–Ω–∏—Ü–∞–º–∏,—Ö—É–ª–∏ —Ç—ã –∫–∞–∫ –¥–∞–ª–±–æ–µ–±",
  "–≤—á–µ—Ä–∞ —Ç—ã –º–æ–ª–æ–¥ —Å–µ–≥–æ–¥–Ω—è —Å—Ç–∞—Ä –∞ –∑–∞–≤—Çp–∞ —Ç—ã –º–∏–ª–∞–Ω–∞ —Å—Ç–∞—Ä", "–ª—é–±–æ–≤—å –æ–¥–Ω–∞ –∞ –¥–æ—Ç–∞ 2",
  "—Ç—ã —Ç—É–ø–æ–π –∫–∞–∫ –ø—Ä–æ–±–∫–∞, –Ω–æ –º–∏–ª—ã–π üòè", "–µ–±–∞—Ç—å, —á—Ç–æ –∑–∞ –¥–µ–±–∏–ª?", "–≤–∞—Å —Ç—É—Ç –≤—Å–µ—Ö —Å—Ä–∞—Ç—å –æ—Ö–æ—Ç–∞",
  "–ø–æ—à—ë–ª –Ω–∞—Ö—É–π —Å–æ —Å–≤–æ–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏", "—è –≤–∏–∂—É, –≤—ã —Ç—É–ø–∏—Ç–µ —Å–Ω–æ–≤–∞", "–Ω—É –≤—ã –∏ –¥–æ–ª–±–æ—ë–±—ã",
  "–¥–∞ –≤—ã –ø—Ä–æ—Å—Ç–æ –æ—Ö—É–µ–ª–∏", "–≤–∞—à IQ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç—É–∞–ª–µ—Ç–Ω–æ–π –±—É–º–∞–≥–∏", "—Å–µ—Ä—å—ë–∑–Ω–æ, –±–ª—è–¥—å?",
  "–µ–±–∞–Ω—ã–π —Ä–æ—Ç, –Ω—É –æ–ø—è—Ç—å –≤—ã", "–¥–∞ –≤—ã –ø–∏–∑–¥–µ—Ü –ø–æ–ª–Ω—ã–π", "–∏–¥–∏ –Ω–∞—Ö—É–π, –ø–æ–∫–∞ –Ω–µ –ø–æ–∑–¥–Ω–æ"
];

const valeraCompliments = [
  "—è –≤–ª—é–±–ª–µ–Ω –≤ —Ç–≤–æ—é –∫—Ä–∞—Å–æ—Ç—É", "—Ç—ã —Å–∏—è–µ—à—å —Å–µ–≥–æ–¥–Ω—è", "—Ç–≤–æ–π —Å—Ç–∏–ª—å –ø—Ä–æ—Å—Ç–æ –±–æ–º–±–∏—á–µ—Å–∫–∏–π",
  "–≤–∞—à–µ–π –ø–∞–ø–µ –º–∞—Ç—å –Ω–µ –Ω—É–∂–µ–Ω?", "–º–∞–º–∞ –¥–æ—Ä–æ–≥–∞—è —á—Ç–æ –ø–µ—Ä—Å–∏–∫ –Ω–∞–ª–∏–≤–Ω–æ–π",
  "–≤–∞—à–∏ —Ä–æ–¥–∏—Ç–µ–ª–∏ –Ω–µ –º–∞—à–∏–Ω–∏—Å—Ç—ã?—Ç–æ–≥–¥–∞ –æ—Ç–∫—É–¥–∞ —É –Ω–∏—Ö —Ç–∞–∫–æ–π –ø–∞—Ä–æ–≤–æ–∑", "–∏–¥–∏ –ø–æ–ø–ª–∞—á—å –Ω–µ–º–æ—â—å"
];

const valeraTrolls = [
  "–Ω—É —Ç—ã –∏ –∫–ª–æ—É–Ω –∫–æ–Ω–µ—á–Ω–æ...", "–º–¥–∞‚Ä¶ —á—Ç–æ –∑–∞ –±—Ä–µ–¥", "–ª—É—á—à–µ –±—ã –º–æ–ª—á–∞–ª", "—è IQ —Ç–µ—Ä—è—é, —á–∏—Ç–∞—è —Ç–µ–±—è",
  "–æ—Ö —É–∂ —ç—Ç–∏ –∏–¥–∏–æ—Ç—ã", "–Ω—É –∏ –≥–ª—É–ø–æ—Å—Ç—å", "–º–∞–º—É –µ–±–∞–ª", "—É–±–µ–∂–∞–ª –≤ —Å—Ç—Ä–∞—Ö–µ –æ—Ç —Å—é–¥–∞",
  "Na, dann heul doch jetzt los, du Dicker."
];

const kisa = {
  nick: "–ö–∏—Å–∞",
  color: "#ff69b4",
  joined: false,
  phrases: [
    "—Ç—ã —Ç–∞–∫–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π üòè", "—Å —Ç–æ–±–æ–π —Ç–∞–∫ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ üòâ", "–º–º–º, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –æ–±—â–∞—Ç—å—Å—è üòò",
    "—É—Ö —Ç—ã, –∫–∞–∫ –∫—Ä—É—Ç–æ üòç", "—Ç–∞–∫ –µ—Å–ª–∏ —Ç—ã –æ–±–∏–¥–µ—à—å –º–µ–Ω—è —è –ø–æ–∂–∞–ª—É—é—Å—å –≤–∞–ª–µ—Ä–µ", "–ª—é–±–ª—é —Ç–µ–±—è –º–∞–ª—ã—à–∫–∞",
    "–¥–∞–≤–∞–π –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è", "–∞ —Ç—ã –ø—Ä–∏–∫–æ–ª—å–Ω—ã–π", "—Ç—ã –º–∏–ª—ã–π", "–ø–æ–∫–∞—Ç–∞–µ–º—Å—è –Ω–∞ —Ç–≤–æ–µ–π —Ç–∞—á–∫–µ?",
    "–±—ã–ª –±—ã —Ç—ã –±–æ—Ç–æ–º..."
  ]
};

const kisaFlirtResponses = [
  { trigger: /–∫—Ç–æ –≤–æ–æ–±—â–µ —Ç—É—Ç/i, responses: ["–ù—É —è —Ç—É—Ç‚Ä¶ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è üòâ", "–¢–æ–ª—å–∫–æ —è, –í–∞–ª–µ—Ä–∞ üòè"] },
  { trigger: /—á—ë –º–æ–ª—á–∏–º/i, responses: ["–î–∞ —è —Å–ª—É—à–∞—é‚Ä¶ —Ç–æ–ª—å–∫–æ —Ç–µ–±—è üòò", "–ù—É —è –∑–¥–µ—Å—å üòè"] },
  { trigger: /—á–µ –±–ª—è|–∏–¥–∏ –Ω–∞ —Ö—É–π|—Ç—ã –æ—Ö—É–µ–ª|–¥–∞ –Ω—É –Ω–∞—Ö—É–π|—ë–±–∞–Ω—ã–π|–¥–æ–ª–±–æ—ë–±—ã/i, responses: ["–û–π, –í–∞–ª–µ—Ä–∞‚Ä¶ —Ç—ã —Ç–∞–∫–æ–π üòò", "–•–∞—Ö–∞, —Ç—ã —à–∞–ª—É–Ω üòè"] }
];

function sendBotMessage(bot, text) {
  io.emit("chat-message", {
    nick: bot.nick,
    color: bot.color,
    text
  });
}
function getValeraResponse(msg) {
  const lower = msg.toLowerCase();
  for (const troll of valeraTrolls) {
    if (lower.includes(troll.toLowerCase())) return random(valeraRandomPhrases);
  }
  if (Math.random() < 0.3) return random(valeraCompliments);
  return random(valeraRandomPhrases);
}

io.on("connection", (socket) => {
  socket.nickname = –ì–æ—Å—Ç—å${Math.floor(Math.random() * 1000)};
  socket.color = getRandomColor();
  io.emit("system", ${socket.nickname} –≤–æ—à—ë–ª –≤ —á–∞—Ç);

  if (!valera.joined) {
    setTimeout(() => {
      io.emit("system", ${valera.nick} –≤–æ—à—ë–ª –≤ —á–∞—Ç);
      valera.joined = true;
    }, 1000);
  }

  if (!kisa.joined) {
    setTimeout(() => {
      io.emit("system", ${kisa.nick} –≤–æ—à—ë–ª –≤ —á–∞—Ç);
      kisa.joined = true;
    }, 1500);
  }

  socket.on("chat-message", (msgText) => {
    const fromNick = socket.nickname || "–ì–æ—Å—Ç—å";
    io.emit("chat-message", {
      nick: fromNick,
      color: socket.color || "#ffffff",
      text: msgText
    });

    if (valera.joined) {
      const resp = getValeraResponse(msgText);
      setTimeout(() => sendBotMessage(valera, resp), 1000 + Math.random() * 2000);
    }

    if (kisa.joined) {
      for (const r of kisaFlirtResponses) {
        if (r.trigger.test(msgText)) {
          const resp = random(r.responses);
          setTimeout(() => sendBotMessage(kisa, resp), 1500 + Math.random() * 2000);
        }
      }
    }
  });
});

server.listen(PORT, () => {
  console.log(BubbleChat –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT});
});
